import QtQuick 2.15
import QtQuick.Layouts 1.15
import PushClone 1.0
import "../components" as Components

Rectangle {
    id: root
    anchors.fill: parent
    clip: true
    color: PushCloneTheme.background

    // ═══════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════
    property bool showMasterReturns: false
    property int trackBank: 0
    property int returnBank: 0
    readonly property int stripsPerBank: 4
    readonly property int returnsPerBank: 3

    property int parameterIndex: 0
    property var parameterOptions: [
        { label: qsTr("PAN"), key: "pan" },
        { label: qsTr("SEND A"), key: "sendA" },
        { label: qsTr("SEND B"), key: "sendB" },
        { label: qsTr("FX"), key: "fx" }
    ]

    property int selectedTrackIndex: 0
    property int selectedReturnIndex: 0
    property bool masterSelected: false

    readonly property string currentParameterLabel: parameterOptions[parameterIndex].label
    readonly property string currentParameterKey: parameterOptions[parameterIndex].key

    readonly property real stripWidth: Math.max(110,
                                                (stripsArea.width - PushCloneTheme.spacing * (root.stripsPerBank - 1))
                                                / root.stripsPerBank)

    // ═══════════════════════════════════════════════════════
    // DATA (mock data for UI layout)
    // ═══════════════════════════════════════════════════════
    ListModel {
        id: trackModel
        ListElement { name: "Track 01"; tag: "DRM"; clip: "Beat Loop"; color: "#ff4c4c";
            meterL: 0.82; meterR: 0.78; volume: 0.85; volumeLabel: "-2.5 dB";
            panLabel: "C"; panRatio: 0.5; sendA: 0.32; sendAText: "32%";
            sendB: 0.1; sendBText: "10%"; fxValue: 0.55; fxText: "HPF 120Hz";
            muted: false; solo: false; armed: false; needsPickup: false }
        ListElement { name: "Track 02"; tag: "BASS"; clip: "Bass Loop"; color: "#4cff4c";
            meterL: 0.6; meterR: 0.52; volume: 0.6; volumeLabel: "-6.0 dB";
            panLabel: "L12"; panRatio: 0.35; sendA: 0.4; sendAText: "40%";
            sendB: 0.12; sendBText: "12%"; fxValue: 0.2; fxText: "Chorus 20%";
            muted: false; solo: false; armed: false; needsPickup: true }
        ListElement { name: "Track 03"; tag: "SYN"; clip: "Pad Drone"; color: "#4cffff";
            meterL: 0.5; meterR: 0.45; volume: 0.7; volumeLabel: "-3.5 dB";
            panLabel: "R8"; panRatio: 0.65; sendA: 0.18; sendAText: "18%";
            sendB: 0.35; sendBText: "35%"; fxValue: 0.74; fxText: "LPF 2.3k";
            muted: false; solo: false; armed: true; needsPickup: false }
        ListElement { name: "Track 04"; tag: "SFX"; clip: "Riser"; color: "#ffa54c";
            meterL: 0.35; meterR: 0.3; volume: 0.25; volumeLabel: "-∞";
            panLabel: "C"; panRatio: 0.5; sendA: 0.6; sendAText: "60%";
            sendB: 0.22; sendBText: "22%"; fxValue: 0.4; fxText: "Delay 3/16";
            muted: true; solo: false; armed: false; needsPickup: false }
        ListElement { name: "Track 05"; tag: "VOX"; clip: "Lead Vox"; color: "#ff4ca5";
            meterL: 0.75; meterR: 0.73; volume: 0.76; volumeLabel: "-3.0 dB";
            panLabel: "L6"; panRatio: 0.45; sendA: 0.58; sendAText: "58%";
            sendB: 0.44; sendBText: "44%"; fxValue: 0.66; fxText: "Comp 2:1";
            muted: false; solo: true; armed: false; needsPickup: false }
        ListElement { name: "Track 06"; tag: "HIT"; clip: "One Shot"; color: "#a54cff";
            meterL: 0.22; meterR: 0.2; volume: 0.3; volumeLabel: "-18 dB";
            panLabel: "R20"; panRatio: 0.75; sendA: 0.12; sendAText: "12%";
            sendB: 0.7; sendBText: "70%"; fxValue: 0.28; fxText: "Gated";
            muted: false; solo: false; armed: false; needsPickup: false }
    }

    ListModel {
        id: returnModel
        ListElement { name: "Return A"; tag: "RET"; clip: "Hall"; color: "#4ca5ff";
            meterL: 0.55; meterR: 0.5; volume: 0.6; volumeLabel: "-4.0 dB";
            panLabel: "C"; panRatio: 0.5; sendA: 0.0; sendAText: "-";
            sendB: 0.0; sendBText: "-"; fxValue: 0.7; fxText: "Hall";
            muted: false; solo: false; armed: false; needsPickup: false }
        ListElement { name: "Return B"; tag: "RET"; clip: "Delay"; color: "#4cff4c";
            meterL: 0.48; meterR: 0.44; volume: 0.5; volumeLabel: "-6.0 dB";
            panLabel: "C"; panRatio: 0.5; sendA: 0.0; sendAText: "-";
            sendB: 0.0; sendBText: "-"; fxValue: 0.5; fxText: "Ping Pong";
            muted: false; solo: false; armed: false; needsPickup: false }
        ListElement { name: "Return C"; tag: "RET"; clip: "Trash"; color: "#ff4c4c";
            meterL: 0.36; meterR: 0.3; volume: 0.45; volumeLabel: "-8.0 dB";
            panLabel: "C"; panRatio: 0.5; sendA: 0.0; sendAText: "-";
            sendB: 0.0; sendBText: "-"; fxValue: 0.45; fxText: "Dist";
            muted: false; solo: false; armed: false; needsPickup: false }
        ListElement { name: "Return D"; tag: "RET"; clip: "Grain"; color: "#ffff4c";
            meterL: 0.32; meterR: 0.3; volume: 0.4; volumeLabel: "-10 dB";
            panLabel: "C"; panRatio: 0.5; sendA: 0.0; sendAText: "-";
            sendB: 0.0; sendBText: "-"; fxValue: 0.25; fxText: "Granular";
            muted: false; solo: false; armed: false; needsPickup: false }
    }

    property var masterChannel: ({
        name: "Master",
        tag: "MST",
        clip: "",
        color: "#00ffff",
        meterL: 0.78,
        meterR: 0.76,
        volume: 0.85,
        volumeLabel: "0.0 dB",
        panLabel: "C",
        panRatio: 0.5,
        sendA: 0.0,
        sendAText: "-",
        sendB: 0.0,
        sendBText: "-",
        fxValue: 0.4,
        fxText: "Limiter",
        muted: false,
        solo: false,
        armed: false,
        needsPickup: false
    })

    // ═══════════════════════════════════════════════════════
    // HELPERS
    // ═══════════════════════════════════════════════════════
    function trackForIndex(globalIndex) {
        if (globalIndex < 0 || globalIndex >= trackModel.count)
            return null
        return trackModel.get(globalIndex)
    }

    function returnForIndex(globalIndex) {
        if (globalIndex < 0 || globalIndex >= returnModel.count)
            return null
        return returnModel.get(globalIndex)
    }

    function parameterValue(channel) {
        if (!channel)
            return ""
        switch(currentParameterKey) {
        case "pan": return channel.panLabel
        case "sendA": return channel.sendAText
        case "sendB": return channel.sendBText
        case "fx": return channel.fxText
        default: return channel.volumeLabel
        }
    }

    function parameterRatio(channel) {
        if (!channel)
            return 0
        switch(currentParameterKey) {
        case "pan": return channel.panRatio
        case "sendA": return channel.sendA
        case "sendB": return channel.sendB
        case "fx": return channel.fxValue
        default: return channel.volume
        }
    }

    function nextBank(isReturn) {
        if (isReturn) {
            var totalBanks = Math.ceil(returnModel.count / returnsPerBank)
            returnBank = (returnBank + 1) % Math.max(1, totalBanks)
        } else {
            var trackBanks = Math.ceil(trackModel.count / stripsPerBank)
            trackBank = (trackBank + 1) % Math.max(1, trackBanks)
        }
    }

    function prevBank(isReturn) {
        if (isReturn) {
            var totalBanks = Math.ceil(returnModel.count / returnsPerBank)
            returnBank = (returnBank - 1 + Math.max(1, totalBanks)) % Math.max(1, totalBanks)
        } else {
            var trackBanks = Math.ceil(trackModel.count / stripsPerBank)
            trackBank = (trackBank - 1 + Math.max(1, trackBanks)) % Math.max(1, trackBanks)
        }
    }

    function displayedTrackIndex(localIndex) {
        return trackBank * stripsPerBank + localIndex
    }

    function displayedReturnIndex(localIndex) {
        return returnBank * returnsPerBank + localIndex
    }

    function activeTrack() {
        return !showMasterReturns ? trackForIndex(selectedTrackIndex) : null
    }

    function activeReturn() {
        return showMasterReturns && !masterSelected ? returnForIndex(selectedReturnIndex) : null
    }

    // ═══════════════════════════════════════════════════════
    // LAYOUT
    // ═══════════════════════════════════════════════════════

    Column {
        anchors.fill: parent
        anchors.margins: PushCloneTheme.spacing
        spacing: PushCloneTheme.spacing

        // Header controls
        Rectangle {
            id: header
            height: 70
            width: parent.width
            radius: PushCloneTheme.radius
            color: PushCloneTheme.surface
            border.color: PushCloneTheme.border

            RowLayout {
                anchors.fill: parent
                anchors.margins: PushCloneTheme.spacing
                spacing: PushCloneTheme.spacing

                Column {
                    spacing: 4
                    Layout.preferredWidth: 170
                    Layout.alignment: Qt.AlignVCenter

                    Text {
                        text: showMasterReturns ? qsTr("Return Bank %1").arg(returnBank + 1)
                                                : qsTr("Track Bank %1").arg(trackBank + 1)
                        color: PushCloneTheme.text
                        font.pixelSize: PushCloneTheme.fontSizeMedium
                        font.family: PushCloneTheme.fontFamily
                    }

                    Text {
                        text: showMasterReturns ? qsTr("Returns A-%1").arg(String.fromCharCode(65 + Math.min(returnModel.count - 1,
                                                                                                      returnBank * returnsPerBank + returnsPerBank - 1)))
                                                : qsTr("Scene • Intro")
                        color: PushCloneTheme.textDim
                        font.pixelSize: PushCloneTheme.fontSizeSmall
                        font.family: PushCloneTheme.fontFamily
                    }
                }

                // Parameter segmented control
                Row {
                    spacing: PushCloneTheme.spacingSmall
                    Layout.alignment: Qt.AlignVCenter
                    Layout.fillWidth: true

                    Repeater {
                        model: parameterOptions.length
                        Rectangle {
                            property bool active: root.parameterIndex === index
                            height: 34
                            width: 90
                            radius: PushCloneTheme.radius
                            color: active ? PushCloneTheme.surfaceActive : PushCloneTheme.background
                            border.width: 1
                            border.color: active ? PushCloneTheme.primary : PushCloneTheme.border

                            Text {
                                anchors.centerIn: parent
                                text: parameterOptions[index].label
                                color: active ? PushCloneTheme.primary : PushCloneTheme.text
                                font.pixelSize: PushCloneTheme.fontSizeSmall
                                font.family: PushCloneTheme.fontFamily
                            }

                            MouseArea {
                                anchors.fill: parent
                                onClicked: root.parameterIndex = index
                            }
                        }
                    }
                }

                Row {
                    spacing: PushCloneTheme.spacing
                    Layout.alignment: Qt.AlignRight | Qt.AlignVCenter

                    // Mode toggle
                    Rectangle {
                        width: 130
                        height: 34
                        radius: PushCloneTheme.radius
                        border.color: PushCloneTheme.border
                        color: showMasterReturns ? PushCloneTheme.surfaceActive : PushCloneTheme.background

                        Text {
                            anchors.centerIn: parent
                            text: showMasterReturns ? qsTr("Master · Return") : qsTr("Track View")
                            color: showMasterReturns ? PushCloneTheme.primary : PushCloneTheme.text
                            font.pixelSize: PushCloneTheme.fontSizeSmall
                            font.family: PushCloneTheme.fontFamily
                        }

                        MouseArea {
                            anchors.fill: parent
                            onClicked: {
                                showMasterReturns = !showMasterReturns
                                if (showMasterReturns) {
                                    masterSelected = false
                                    selectedReturnIndex = 0
                                }
                            }
                        }
                    }

                    Row {
                        spacing: PushCloneTheme.spacingSmall

                        Rectangle {
                            width: 60
                            height: 34
                            radius: PushCloneTheme.radius
                            border.color: PushCloneTheme.border
                            color: PushCloneTheme.background

                            Text {
                                anchors.centerIn: parent
                                text: "←"
                                color: PushCloneTheme.text
                                font.pixelSize: PushCloneTheme.fontSizeMedium
                                font.family: PushCloneTheme.fontFamily
                            }

                            MouseArea {
                                anchors.fill: parent
                                onClicked: prevBank(showMasterReturns)
                            }
                        }

                        Rectangle {
                            width: 60
                            height: 34
                            radius: PushCloneTheme.radius
                            border.color: PushCloneTheme.border
                            color: PushCloneTheme.background

                            Text {
                                anchors.centerIn: parent
                                text: "→"
                                color: PushCloneTheme.text
                                font.pixelSize: PushCloneTheme.fontSizeMedium
                                font.family: PushCloneTheme.fontFamily
                            }

                            MouseArea {
                                anchors.fill: parent
                                onClicked: nextBank(showMasterReturns)
                            }
                        }
                    }
                }
            }
        }

        // Content area (strips + detail panel)
        Row {
            id: bodyRow
            spacing: PushCloneTheme.spacing
            anchors.horizontalCenter: parent.horizontalCenter
            width: parent.width
            height: parent.height - header.height - masterInfo.height - PushCloneTheme.spacing * 2

            Item {
                id: stripsArea
                width: parent.width - detailPanel.width - PushCloneTheme.spacing
                height: parent.height

                Row {
                    anchors.fill: parent
                    spacing: PushCloneTheme.spacing

                    Repeater {
                        id: stripRepeater
                        model: root.stripsPerBank

                        Components.MixChannelStrip {
                            readonly property bool inReturnMode: root.showMasterReturns
                            readonly property bool isMasterStrip: inReturnMode && index === root.returnsPerBank
                            readonly property int globalTrackIndex: root.displayedTrackIndex(index)
                            readonly property int globalReturnIndex: root.displayedReturnIndex(index)
                            readonly property var channelData: {
                                if (inReturnMode) {
                                    if (isMasterStrip)
                                        return root.masterChannel
                                    if (index < root.returnsPerBank) {
                                        return globalReturnIndex < returnModel.count ? returnModel.get(globalReturnIndex) : null
                                    }
                                    return null
                                }

                                return globalTrackIndex < trackModel.count ? trackModel.get(globalTrackIndex) : null
                            }

                            visible: channelData !== null
                            opacity: channelData ? 1 : 0.2
                            width: root.stripWidth
                            height: stripsArea.height

                            trackName: channelData ? channelData.name : ""
                            trackTag: channelData ? channelData.tag : ""
                            clipName: channelData ? channelData.clip : ""
                            trackColor: channelData ? channelData.color : PushCloneTheme.primary
                            meterLeft: channelData ? channelData.meterL : 0
                            meterRight: channelData ? channelData.meterR : 0
                            mainValue: root.parameterValue(channelData)
                            mainLabel: root.currentParameterLabel
                            secondaryLabel: qsTr("Vol")
                            secondaryValue: channelData ? channelData.volumeLabel : ""
                            secondaryRatio: channelData ? channelData.volume : 0
                            isMuted: channelData ? channelData.muted : false
                            isSolo: channelData ? channelData.solo : false
                            isArmed: channelData ? channelData.armed : false
                            isSelected: (!inReturnMode && channelData && globalTrackIndex === root.selectedTrackIndex)
                                         || (inReturnMode && !isMasterStrip && channelData && globalReturnIndex === root.selectedReturnIndex && !root.masterSelected)
                                         || (inReturnMode && isMasterStrip && root.masterSelected)
                            needsPickup: channelData ? channelData.needsPickup : false
                            faderValue: root.parameterRatio(channelData)
                            faderPhysicalValue: channelData && channelData.needsPickup ? Math.max(0, channelData.volume - 0.1) : -1

                            onStripTapped: {
                                if (inReturnMode) {
                                    if (isMasterStrip) {
                                        root.masterSelected = true
                                    } else if (channelData) {
                                        root.masterSelected = false
                                        root.selectedReturnIndex = globalReturnIndex
                                    }
                                } else {
                                    if (channelData)
                                        root.selectedTrackIndex = globalTrackIndex
                                }
                            }
                        }
                    }
                }
            }

            // Detail panel
            Rectangle {
                id: detailPanel
                property var detailData: root.showMasterReturns ? (root.masterSelected ? root.masterChannel : root.activeReturn())
                                                               : root.activeTrack()
                width: 210
                height: parent.height
                radius: PushCloneTheme.radius
                color: PushCloneTheme.surface
                border.color: PushCloneTheme.border

                Column {
                    anchors.fill: parent
                    anchors.margins: PushCloneTheme.spacing
                    spacing: PushCloneTheme.spacing

                    Text {
                        text: detailPanel.detailData ? detailPanel.detailData.name : qsTr("No Selection")
                        color: PushCloneTheme.text
                        font.pixelSize: PushCloneTheme.fontSizeMedium
                        font.family: PushCloneTheme.fontFamily
                    }

                    Text {
                        text: root.showMasterReturns ? (root.masterSelected ? qsTr("Master Channel") : qsTr("Return"))
                                                     : qsTr("Track")
                        color: PushCloneTheme.textDim
                        font.pixelSize: PushCloneTheme.fontSizeSmall
                        font.family: PushCloneTheme.fontFamily
                    }

                    Rectangle {
                        width: parent.width
                        height: 120
                        radius: PushCloneTheme.radius
                        color: PushCloneTheme.background

                        Column {
                            anchors.centerIn: parent
                            spacing: 8

                            Text {
                                text: root.currentParameterLabel
                                color: PushCloneTheme.textDim
                                font.pixelSize: PushCloneTheme.fontSizeSmall
                                horizontalAlignment: Text.AlignHCenter
                                width: parent.width
                            }

                            Text {
                                text: detailPanel.detailData ? root.parameterValue(detailPanel.detailData) : "--"
                                color: PushCloneTheme.primary
                                font.pixelSize: PushCloneTheme.fontSizeXLarge
                                font.family: PushCloneTheme.fontFamilyMono
                                font.bold: true
                                horizontalAlignment: Text.AlignHCenter
                                width: parent.width
                            }

                            Rectangle {
                                width: parent.width - PushCloneTheme.spacing
                                height: 6
                                radius: 3
                                color: PushCloneTheme.surfaceHover

                                Rectangle {
                                    width: (parent.width) * root.parameterRatio(detailPanel.detailData)
                                    height: parent.height
                                    radius: 3
                                    color: PushCloneTheme.primary
                                }
                            }
                        }
                    }

                    Column {
                        spacing: 6

                        Text {
                            text: qsTr("Volume: %1").arg(detailPanel.detailData ? detailPanel.detailData.volumeLabel : "--")
                            color: PushCloneTheme.text
                            font.pixelSize: PushCloneTheme.fontSizeSmall
                            font.family: PushCloneTheme.fontFamily
                        }

                        Text {
                            text: qsTr("Pan: %1").arg(detailPanel.detailData ? detailPanel.detailData.panLabel : "--")
                            color: PushCloneTheme.textDim
                            font.pixelSize: PushCloneTheme.fontSizeSmall
                        }

                        Text {
                            text: qsTr("Send A: %1 / Send B: %2")
                                  .arg(detailPanel.detailData ? detailPanel.detailData.sendAText : "--")
                                  .arg(detailPanel.detailData ? detailPanel.detailData.sendBText : "--")
                            color: PushCloneTheme.textDim
                            font.pixelSize: PushCloneTheme.fontSizeSmall
                        }

                        Text {
                            text: detailPanel.detailData && detailPanel.detailData.clip.length
                                  ? qsTr("Clip: %1").arg(detailPanel.detailData.clip)
                                  : qsTr("Clip: --")
                            color: PushCloneTheme.textDim
                            font.pixelSize: PushCloneTheme.fontSizeSmall
                            wrapMode: Text.WordWrap
                        }
                    }

                }
            }
        }

        // Master info row (always shown)
        Rectangle {
            id: masterInfo
            height: 70
            width: parent.width
            radius: PushCloneTheme.radius
            color: PushCloneTheme.surface
            border.color: PushCloneTheme.border

            Row {
                anchors.fill: parent
                anchors.margins: PushCloneTheme.spacing
                spacing: PushCloneTheme.spacing

                Column {
                    spacing: 4
                    width: 200

                    Text {
                        text: qsTr("Master Level")
                        color: PushCloneTheme.text
                        font.pixelSize: PushCloneTheme.fontSizeSmall
                        font.family: PushCloneTheme.fontFamily
                    }

                    Rectangle {
                        width: parent.width
                        height: 12
                        radius: 6
                        color: PushCloneTheme.background

                        Rectangle {
                            width: parent.width * masterChannel.meterL
                            height: parent.height
                            radius: 6
                            color: PushCloneTheme.primary
                        }
                    }
                }

                Column {
                    spacing: 4
                    width: 160

                    Text {
                        text: qsTr("RMS %1").arg("-3.0 dB")
                        color: PushCloneTheme.text
                        font.pixelSize: PushCloneTheme.fontSizeSmall
                    }
                    Text {
                        text: qsTr("Cue Mix 70% → B")
                        color: PushCloneTheme.textDim
                        font.pixelSize: PushCloneTheme.fontSizeSmall
                    }
                }

                Column {
                    spacing: 6
                    anchors.verticalCenter: parent.verticalCenter

                    Text {
                        text: qsTr("Crossfader")
                        color: PushCloneTheme.textDim
                        font.pixelSize: PushCloneTheme.fontSizeSmall
                    }

                    Rectangle {
                        width: 260
                        height: 8
                        radius: 4
                        color: PushCloneTheme.background

                        Rectangle {
                            width: 4
                            height: parent.height + 4
                            radius: 2
                            color: PushCloneTheme.primary
                            anchors.verticalCenter: parent.verticalCenter
                            x: parent.width * 0.35
                        }
                    }
                }
            }
        }
    }
}
